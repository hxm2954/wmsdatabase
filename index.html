<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Database Schema ERD - Complete</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    const domainColors = {
      core: { header: '#1e40af', light: '#dbeafe' },
      rbac: { header: '#7c3aed', light: '#ede9fe' },
      chat: { header: '#059669', light: '#d1fae5' },
      database: { header: '#d97706', light: '#fef3c7' },
      query: { header: '#dc2626', light: '#fee2e2' },
      dashboard: { header: '#0891b2', light: '#cffafe' },
      playlist: { header: '#be185d', light: '#fce7f3' },
      ai: { header: '#4f46e5', light: '#e0e7ff' }
    };

    // EXACT SCHEMA FROM USER'S SQL FILE
    const tables = {
      // ==================== CORE ====================
      organizations: { domain: 'core', columns: [
        { name: 'id', type: 'uuid', isPK: true },
        { name: 'name', type: 'text' },
        { name: 'created_at', type: 'timestamptz' }
      ]},
      
      sites: { domain: 'core', columns: [
        { name: 'id', type: 'uuid', isPK: true },
        { name: 'name', type: 'text' },
        { name: 'organization_id', type: 'uuid', isFK: true },
        { name: 'created_at', type: 'timestamptz' }
      ]},
      
      users: { domain: 'core', columns: [
        { name: 'id', type: 'uuid', isPK: true },
        { name: 'email', type: 'text' },
        { name: 'name', type: 'text' },
        { name: 'role', type: 'text' },
        { name: 'site_id', type: 'uuid', isFK: true },
        { name: 'organization_id', type: 'uuid', isFK: true },
        { name: 'created_at', type: 'timestamptz' },
        { name: 'status', type: 'varchar' },
        { name: 'role_id', type: 'uuid', isFK: true }
      ]},
      
      user_organizations: { domain: 'core', columns: [
        { name: 'id', type: 'uuid', isPK: true },
        { name: 'user_id', type: 'uuid', isFK: true },
        { name: 'organization_id', type: 'uuid', isFK: true },
        { name: 'created_at', type: 'timestamptz' },
        { name: 'is_primary', type: 'boolean' }
      ]},
      
      user_sites: { domain: 'core', columns: [
        { name: 'id', type: 'uuid', isPK: true },
        { name: 'user_id', type: 'uuid', isFK: true },
        { name: 'site_id', type: 'uuid', isFK: true },
        { name: 'created_at', type: 'timestamptz' },
        { name: 'is_primary', type: 'boolean' }
      ]},

      // ==================== RBAC ====================
      roles: { domain: 'rbac', columns: [
        { name: 'id', type: 'uuid', isPK: true },
        { name: 'name', type: 'varchar', isUnique: true },
        { name: 'description', type: 'text' },
        { name: 'is_system', type: 'boolean' },
        { name: 'created_at', type: 'timestamptz' },
        { name: 'updated_at', type: 'timestamptz' }
      ]},
      
      role_permissions: { domain: 'rbac', columns: [
        { name: 'id', type: 'uuid', isPK: true },
        { name: 'role_id', type: 'uuid', isFK: true },
        { name: 'resource_type', type: 'varchar' },
        { name: 'resource_id', type: 'varchar' },
        { name: 'action', type: 'varchar' },
        { name: 'conditions', type: 'jsonb' },
        { name: 'created_at', type: 'timestamptz' },
        { name: 'updated_at', type: 'timestamptz' },
        { name: 'priority', type: 'integer' },
        { name: 'scope', type: 'text' }
      ]},

      // ==================== CHAT ====================
      chat_sessions: { domain: 'chat', columns: [
        { name: 'id', type: 'uuid', isPK: true },
        { name: 'title', type: 'text' },
        { name: 'is_active', type: 'boolean' },
        { name: 'organization_id', type: 'uuid', isFK: true },
        { name: 'site_id', type: 'uuid', isFK: true },
        { name: 'created_by', type: 'uuid', isFK: true },
        { name: 'created_at', type: 'timestamptz' },
        { name: 'updated_at', type: 'timestamptz' }
      ]},
      
      chat_messages: { domain: 'chat', columns: [
        { name: 'id', type: 'uuid', isPK: true },
        { name: 'session_id', type: 'uuid', isFK: true },
        { name: 'sender_type', type: 'text' },
        { name: 'content', type: 'text' },
        { name: 'query_id', type: 'uuid', isFK: true },
        { name: 'widget_id', type: 'uuid', isFK: true },
        { name: 'created_at', type: 'timestamptz' }
      ]},

      // ==================== DATABASE ====================
      database_connections: { domain: 'database', columns: [
        { name: 'id', type: 'uuid', isPK: true },
        { name: 'name', type: 'varchar' },
        { name: 'type', type: 'varchar' },
        { name: 'organization_id', type: 'uuid', isFK: true },
        { name: 'site_id', type: 'uuid', isFK: true },
        { name: 'details', type: 'jsonb' },
        { name: 'created_by', type: 'uuid', isFK: true },
        { name: 'created_at', type: 'timestamptz' },
        { name: 'updated_at', type: 'timestamptz' },
        { name: 'function_name', type: 'varchar' },
        { name: 'function_definition', type: 'text' },
        { name: 'function_parameters', type: 'jsonb' },
        { name: 'is_function_enabled', type: 'boolean' },
        { name: 'last_deployed', type: 'timestamptz' }
      ]},
      
      database_table_access: { domain: 'database', columns: [
        { name: 'id', type: 'uuid', isPK: true },
        { name: 'connection_id', type: 'uuid', isFK: true },
        { name: 'table_name', type: 'text' },
        { name: 'schema_name', type: 'text' },
        { name: 'has_access', type: 'boolean' },
        { name: 'created_by', type: 'uuid', isFK: true },
        { name: 'created_at', type: 'timestamptz' },
        { name: 'updated_at', type: 'timestamptz' }
      ]},

      // ==================== QUERY ====================
      contexts: { domain: 'query', columns: [
        { name: 'id', type: 'uuid', isPK: true },
        { name: 'organization_id', type: 'uuid', isFK: true },
        { name: 'site_id', type: 'uuid', isFK: true },
        { name: 'content', type: 'text' },
        { name: 'created_by', type: 'uuid', isFK: true },
        { name: 'created_at', type: 'timestamptz' },
        { name: 'updated_at', type: 'timestamptz' },
        { name: 'name', type: 'varchar' }
      ]},
      
      context_chunks: { domain: 'query', columns: [
        { name: 'id', type: 'uuid', isPK: true },
        { name: 'context_id', type: 'uuid', isFK: true },
        { name: 'content', type: 'text' },
        { name: 'order_index', type: 'integer' },
        { name: 'created_by', type: 'uuid', isFK: true },
        { name: 'created_at', type: 'timestamptz' },
        { name: 'updated_at', type: 'timestamptz' }
      ]},
      
      sql_queries: { domain: 'query', columns: [
        { name: 'id', type: 'uuid', isPK: true },
        { name: 'user_id', type: 'uuid', isFK: true },
        { name: 'organization_id', type: 'uuid', isFK: true },
        { name: 'site_id', type: 'uuid', isFK: true },
        { name: 'connection_id', type: 'uuid', isFK: true },
        { name: 'original_question', type: 'text' },
        { name: 'enhanced_question', type: 'text' },
        { name: 'context_id', type: 'uuid', isFK: true },
        { name: 'created_at', type: 'timestamptz' },
        { name: 'completed_at', type: 'timestamptz' },
        { name: 'status', type: 'varchar' },
        { name: 'total_attempts', type: 'integer' },
        { name: 'successful_attempt_number', type: 'integer' },
        { name: 'total_tokens_used', type: 'integer' },
        { name: 'question_intent', type: 'text' },
        { name: 'insights', type: 'text' },
        { name: 'tables_used', type: 'array' },
        { name: 'insights_token_usage', type: 'integer' },
        { name: 'insights_generated', type: 'boolean' }
      ]},
      
      sql_query_attempts: { domain: 'query', columns: [
        { name: 'id', type: 'uuid', isPK: true },
        { name: 'query_id', type: 'uuid', isFK: true },
        { name: 'attempt_number', type: 'integer' },
        { name: 'generated_sql', type: 'text' },
        { name: 'prompt_used', type: 'text' },
        { name: 'special_instructions', type: 'text' },
        { name: 'has_results', type: 'boolean' },
        { name: 'result_data', type: 'jsonb' },
        { name: 'error_message', type: 'text' },
        { name: 'execution_time_ms', type: 'integer' },
        { name: 'prompt_tokens', type: 'integer' },
        { name: 'completion_tokens', type: 'integer' },
        { name: 'total_tokens', type: 'integer' },
        { name: 'created_at', type: 'timestamptz' },
        { name: 'reasoning', type: 'text' }
      ]},
      
      sql_query_feedback: { domain: 'query', columns: [
        { name: 'id', type: 'uuid', isPK: true },
        { name: 'query_id', type: 'uuid', isFK: true },
        { name: 'user_id', type: 'uuid', isFK: true },
        { name: 'feedback_type', type: 'text' },
        { name: 'feedback_text', type: 'text' },
        { name: 'corrected_sql', type: 'text' },
        { name: 'created_at', type: 'timestamptz' }
      ]},
      
      sql_usage_metrics: { domain: 'query', columns: [
        { name: 'id', type: 'uuid', isPK: true },
        { name: 'user_id', type: 'uuid', isFK: true },
        { name: 'organization_id', type: 'uuid', isFK: true },
        { name: 'site_id', type: 'uuid', isFK: true },
        { name: 'year', type: 'integer' },
        { name: 'month', type: 'integer' },
        { name: 'day', type: 'integer' },
        { name: 'query_count', type: 'integer' },
        { name: 'successful_query_count', type: 'integer' },
        { name: 'failed_query_count', type: 'integer' },
        { name: 'total_tokens_used', type: 'integer' },
        { name: 'estimated_cost', type: 'numeric' },
        { name: 'created_at', type: 'timestamptz' },
        { name: 'updated_at', type: 'timestamptz' }
      ]},

      // ==================== DASHBOARD ====================
      dashboards: { domain: 'dashboard', columns: [
        { name: 'id', type: 'uuid', isPK: true },
        { name: 'name', type: 'text' },
        { name: 'description', type: 'text' },
        { name: 'layout_config', type: 'jsonb' },
        { name: 'is_default', type: 'boolean' },
        { name: 'organization_id', type: 'uuid', isFK: true },
        { name: 'site_id', type: 'uuid', isFK: true },
        { name: 'created_by', type: 'uuid', isFK: true },
        { name: 'created_at', type: 'timestamptz' },
        { name: 'updated_at', type: 'timestamptz' }
      ]},
      
      widgets: { domain: 'dashboard', columns: [
        { name: 'id', type: 'uuid', isPK: true },
        { name: 'name', type: 'text' },
        { name: 'description', type: 'text' },
        { name: 'type', type: 'text' },
        { name: 'config', type: 'jsonb' },
        { name: 'chart_code', type: 'text' },
        { name: 'query_id', type: 'uuid', isFK: true },
        { name: 'organization_id', type: 'uuid', isFK: true },
        { name: 'site_id', type: 'uuid', isFK: true },
        { name: 'created_by', type: 'uuid', isFK: true },
        { name: 'created_at', type: 'timestamptz' },
        { name: 'updated_at', type: 'timestamptz' },
        { name: 'insights', type: 'jsonb' },
        { name: 'session_id', type: 'uuid', isFK: true },
        { name: 'default_config', type: 'jsonb' }
      ]},
      
      dashboard_widgets: { domain: 'dashboard', columns: [
        { name: 'id', type: 'uuid', isPK: true },
        { name: 'dashboard_id', type: 'uuid', isFK: true },
        { name: 'widget_id', type: 'uuid', isFK: true },
        { name: 'position_x', type: 'integer' },
        { name: 'position_y', type: 'integer' },
        { name: 'width', type: 'integer' },
        { name: 'height', type: 'integer' },
        { name: 'created_at', type: 'timestamptz' },
        { name: 'updated_at', type: 'timestamptz' },
        { name: 'organization_id', type: 'uuid', isFK: true },
        { name: 'site_id', type: 'uuid', isFK: true }
      ]},

      // ==================== PLAYLIST ====================
      playlists: { domain: 'playlist', columns: [
        { name: 'id', type: 'uuid', isPK: true },
        { name: 'name', type: 'text' },
        { name: 'description', type: 'text' },
        { name: 'share_token', type: 'text', isUnique: true },
        { name: 'is_public', type: 'boolean' },
        { name: 'auto_scroll', type: 'boolean' },
        { name: 'scroll_speed', type: 'integer' },
        { name: 'scroll_direction', type: 'text' },
        { name: 'refresh_interval', type: 'integer' },
        { name: 'organization_id', type: 'uuid', isFK: true },
        { name: 'site_id', type: 'uuid', isFK: true },
        { name: 'created_by', type: 'uuid', isFK: true },
        { name: 'created_at', type: 'timestamptz' },
        { name: 'updated_at', type: 'timestamptz' },
        { name: 'is_locked', type: 'boolean' }
      ]},
      
      playlist_dashboards: { domain: 'playlist', columns: [
        { name: 'id', type: 'uuid', isPK: true },
        { name: 'playlist_id', type: 'uuid', isFK: true },
        { name: 'dashboard_id', type: 'uuid', isFK: true },
        { name: 'order_index', type: 'integer' },
        { name: 'scroll_duration', type: 'integer' },
        { name: 'is_enabled', type: 'boolean' },
        { name: 'created_at', type: 'timestamptz' },
        { name: 'updated_at', type: 'timestamptz' },
        { name: 'transition_effect', type: 'text' },
        { name: 'transition_duration', type: 'integer' }
      ]},

      // ==================== AI ====================
      llm_configurations: { domain: 'ai', columns: [
        { name: 'id', type: 'uuid', isPK: true },
        { name: 'organization_id', type: 'uuid', isFK: true },
        { name: 'site_id', type: 'uuid', isFK: true },
        { name: 'provider', type: 'varchar' },
        { name: 'model', type: 'varchar' },
        { name: 'api_key', type: 'text' },
        { name: 'parameters', type: 'jsonb' },
        { name: 'is_default', type: 'boolean' },
        { name: 'created_by', type: 'uuid', isFK: true },
        { name: 'created_at', type: 'timestamptz' },
        { name: 'updated_at', type: 'timestamptz' }
      ]},
      
      schema_vector_stores: { domain: 'ai', columns: [
        { name: 'id', type: 'uuid', isPK: true },
        { name: 'organization_id', type: 'uuid', isFK: true },
        { name: 'site_id', type: 'uuid', isFK: true },
        { name: 'connection_id', type: 'uuid', isFK: true },
        { name: 'store_name', type: 'text' },
        { name: 'chunk_count', type: 'integer' },
        { name: 'table_count', type: 'integer' },
        { name: 'column_count', type: 'integer' },
        { name: 'model_name', type: 'text' },
        { name: 'created_by', type: 'uuid', isFK: true },
        { name: 'created_at', type: 'timestamptz' },
        { name: 'updated_at', type: 'timestamptz' }
      ]},
      
      schema_vectors: { domain: 'ai', columns: [
        { name: 'id', type: 'uuid', isPK: true },
        { name: 'vector_store_id', type: 'uuid', isFK: true },
        { name: 'table_name', type: 'text' },
        { name: 'column_name', type: 'text' },
        { name: 'vector_data', type: 'vector' },
        { name: 'chunk_text', type: 'text' },
        { name: 'metadata', type: 'jsonb' },
        { name: 'created_by', type: 'uuid', isFK: true },
        { name: 'created_at', type: 'timestamptz' },
        { name: 'updated_at', type: 'timestamptz' }
      ]}
    };

    // ALL RELATIONSHIPS FROM SQL CONSTRAINTS
    const relationships = [
      // sites
      { from: 'sites', fromCol: 'organization_id', to: 'organizations', toCol: 'id', type: 'tenant' },
      // users
      { from: 'users', fromCol: 'organization_id', to: 'organizations', toCol: 'id', type: 'tenant' },
      { from: 'users', fromCol: 'site_id', to: 'sites', toCol: 'id', type: 'tenant' },
      { from: 'users', fromCol: 'role_id', to: 'roles', toCol: 'id', type: 'domain' },
      // user_organizations
      { from: 'user_organizations', fromCol: 'organization_id', to: 'organizations', toCol: 'id', type: 'tenant' },
      // user_sites
      { from: 'user_sites', fromCol: 'site_id', to: 'sites', toCol: 'id', type: 'tenant' },
      // role_permissions
      { from: 'role_permissions', fromCol: 'role_id', to: 'roles', toCol: 'id', type: 'domain' },
      // chat_sessions
      { from: 'chat_sessions', fromCol: 'organization_id', to: 'organizations', toCol: 'id', type: 'tenant' },
      { from: 'chat_sessions', fromCol: 'site_id', to: 'sites', toCol: 'id', type: 'tenant' },
      { from: 'chat_sessions', fromCol: 'created_by', to: 'users', toCol: 'id', type: 'domain' },
      // chat_messages
      { from: 'chat_messages', fromCol: 'session_id', to: 'chat_sessions', toCol: 'id', type: 'domain' },
      { from: 'chat_messages', fromCol: 'query_id', to: 'sql_queries', toCol: 'id', type: 'domain' },
      { from: 'chat_messages', fromCol: 'widget_id', to: 'widgets', toCol: 'id', type: 'domain' },
      // database_connections
      { from: 'database_connections', fromCol: 'organization_id', to: 'organizations', toCol: 'id', type: 'tenant' },
      { from: 'database_connections', fromCol: 'site_id', to: 'sites', toCol: 'id', type: 'tenant' },
      { from: 'database_connections', fromCol: 'created_by', to: 'users', toCol: 'id', type: 'domain' },
      // database_table_access
      { from: 'database_table_access', fromCol: 'connection_id', to: 'database_connections', toCol: 'id', type: 'domain' },
      // contexts
      { from: 'contexts', fromCol: 'organization_id', to: 'organizations', toCol: 'id', type: 'tenant' },
      { from: 'contexts', fromCol: 'site_id', to: 'sites', toCol: 'id', type: 'tenant' },
      // context_chunks
      { from: 'context_chunks', fromCol: 'context_id', to: 'contexts', toCol: 'id', type: 'domain' },
      // sql_queries
      { from: 'sql_queries', fromCol: 'user_id', to: 'users', toCol: 'id', type: 'domain' },
      { from: 'sql_queries', fromCol: 'organization_id', to: 'organizations', toCol: 'id', type: 'tenant' },
      { from: 'sql_queries', fromCol: 'site_id', to: 'sites', toCol: 'id', type: 'tenant' },
      { from: 'sql_queries', fromCol: 'connection_id', to: 'database_connections', toCol: 'id', type: 'domain' },
      { from: 'sql_queries', fromCol: 'context_id', to: 'contexts', toCol: 'id', type: 'domain' },
      // sql_query_attempts
      { from: 'sql_query_attempts', fromCol: 'query_id', to: 'sql_queries', toCol: 'id', type: 'domain' },
      // sql_query_feedback
      { from: 'sql_query_feedback', fromCol: 'query_id', to: 'sql_queries', toCol: 'id', type: 'domain' },
      // sql_usage_metrics
      { from: 'sql_usage_metrics', fromCol: 'user_id', to: 'users', toCol: 'id', type: 'domain' },
      { from: 'sql_usage_metrics', fromCol: 'organization_id', to: 'organizations', toCol: 'id', type: 'tenant' },
      { from: 'sql_usage_metrics', fromCol: 'site_id', to: 'sites', toCol: 'id', type: 'tenant' },
      // dashboards
      { from: 'dashboards', fromCol: 'organization_id', to: 'organizations', toCol: 'id', type: 'tenant' },
      { from: 'dashboards', fromCol: 'site_id', to: 'sites', toCol: 'id', type: 'tenant' },
      { from: 'dashboards', fromCol: 'created_by', to: 'users', toCol: 'id', type: 'domain' },
      // widgets
      { from: 'widgets', fromCol: 'query_id', to: 'sql_queries', toCol: 'id', type: 'domain' },
      { from: 'widgets', fromCol: 'organization_id', to: 'organizations', toCol: 'id', type: 'tenant' },
      { from: 'widgets', fromCol: 'site_id', to: 'sites', toCol: 'id', type: 'tenant' },
      { from: 'widgets', fromCol: 'created_by', to: 'users', toCol: 'id', type: 'domain' },
      { from: 'widgets', fromCol: 'session_id', to: 'chat_sessions', toCol: 'id', type: 'domain' },
      // dashboard_widgets
      { from: 'dashboard_widgets', fromCol: 'dashboard_id', to: 'dashboards', toCol: 'id', type: 'domain' },
      { from: 'dashboard_widgets', fromCol: 'widget_id', to: 'widgets', toCol: 'id', type: 'domain' },
      // playlists
      { from: 'playlists', fromCol: 'organization_id', to: 'organizations', toCol: 'id', type: 'tenant' },
      { from: 'playlists', fromCol: 'site_id', to: 'sites', toCol: 'id', type: 'tenant' },
      // playlist_dashboards
      { from: 'playlist_dashboards', fromCol: 'playlist_id', to: 'playlists', toCol: 'id', type: 'domain' },
      { from: 'playlist_dashboards', fromCol: 'dashboard_id', to: 'dashboards', toCol: 'id', type: 'domain' },
      // llm_configurations
      { from: 'llm_configurations', fromCol: 'organization_id', to: 'organizations', toCol: 'id', type: 'tenant' },
      { from: 'llm_configurations', fromCol: 'site_id', to: 'sites', toCol: 'id', type: 'tenant' },
      { from: 'llm_configurations', fromCol: 'created_by', to: 'users', toCol: 'id', type: 'domain' },
      // schema_vector_stores
      { from: 'schema_vector_stores', fromCol: 'organization_id', to: 'organizations', toCol: 'id', type: 'tenant' },
      { from: 'schema_vector_stores', fromCol: 'site_id', to: 'sites', toCol: 'id', type: 'tenant' },
      { from: 'schema_vector_stores', fromCol: 'connection_id', to: 'database_connections', toCol: 'id', type: 'domain' },
      // schema_vectors
      { from: 'schema_vectors', fromCol: 'vector_store_id', to: 'schema_vector_stores', toCol: 'id', type: 'domain' },
    ];

    // Positions optimized for the schema
    const initialPositions = {
      organizations: { x: 850, y: 50 },
      sites: { x: 1100, y: 50 },
      users: { x: 1350, y: 50 },
      roles: { x: 1650, y: 50 },
      role_permissions: { x: 1900, y: 50 },
      user_organizations: { x: 850, y: 320 },
      user_sites: { x: 1100, y: 320 },
      chat_sessions: { x: 1650, y: 320 },
      chat_messages: { x: 1900, y: 320 },
      database_connections: { x: 50, y: 50 },
      database_table_access: { x: 50, y: 480 },
      contexts: { x: 320, y: 50 },
      context_chunks: { x: 320, y: 320 },
      sql_queries: { x: 550, y: 320 },
      sql_query_attempts: { x: 320, y: 700 },
      sql_query_feedback: { x: 600, y: 700 },
      sql_usage_metrics: { x: 880, y: 700 },
      dashboards: { x: 1160, y: 580 },
      widgets: { x: 1430, y: 580 },
      dashboard_widgets: { x: 1160, y: 950 },
      playlists: { x: 1700, y: 580 },
      playlist_dashboards: { x: 1700, y: 950 },
      llm_configurations: { x: 50, y: 700 },
      schema_vector_stores: { x: 50, y: 1000 },
      schema_vectors: { x: 330, y: 1000 },
    };

    const TABLE_WIDTH = 230;
    const ROW_HEIGHT = 22;
    const HEADER_HEIGHT = 34;

    const TableCard = ({ name, data, position, onDrag, isHighlighted, highlightedCols, onMouseEnter, onMouseLeave }) => {
      const [isDragging, setIsDragging] = useState(false);
      const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
      const colors = domainColors[data.domain];

      const handleMouseDown = (e) => {
        if (e.target.closest('.table-header')) {
          e.preventDefault();
          setIsDragging(true);
          setDragStart({ x: e.clientX - position.x, y: e.clientY - position.y });
        }
      };

      useEffect(() => {
        if (!isDragging) return;
        const handleMouseMove = (e) => {
          onDrag(name, { x: Math.max(0, e.clientX - dragStart.x), y: Math.max(0, e.clientY - dragStart.y) });
        };
        const handleMouseUp = () => setIsDragging(false);
        window.addEventListener('mousemove', handleMouseMove);
        window.addEventListener('mouseup', handleMouseUp);
        return () => {
          window.removeEventListener('mousemove', handleMouseMove);
          window.removeEventListener('mouseup', handleMouseUp);
        };
      }, [isDragging, dragStart, name, onDrag]);

      return (
        <div
          onMouseEnter={onMouseEnter}
          onMouseLeave={onMouseLeave}
          style={{
            position: 'absolute',
            left: position.x,
            top: position.y,
            width: TABLE_WIDTH,
            background: '#ffffff',
            borderRadius: '8px',
            boxShadow: isHighlighted ? `0 0 0 3px ${colors.header}, 0 10px 40px rgba(0,0,0,0.2)` : '0 2px 8px rgba(0,0,0,0.08)',
            border: `1px solid ${isHighlighted ? colors.header : '#e2e8f0'}`,
            fontSize: '11px',
            overflow: 'hidden',
            transition: 'box-shadow 0.15s, border-color 0.15s',
            zIndex: isDragging ? 1000 : (isHighlighted ? 100 : 1)
          }}
        >
          <div
            className="table-header"
            onMouseDown={handleMouseDown}
            style={{
              background: colors.header,
              color: 'white',
              padding: '8px 10px',
              fontWeight: '600',
              fontSize: '11px',
              display: 'flex',
              alignItems: 'center',
              gap: '6px',
              cursor: isDragging ? 'grabbing' : 'grab',
              userSelect: 'none'
            }}
          >
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
              <rect x="3" y="3" width="18" height="18" rx="2"/>
              <line x1="3" y1="9" x2="21" y2="9"/>
            </svg>
            {name}
          </div>
          <div>
            {data.columns.map((col, i) => {
              const isHighlightedCol = highlightedCols?.includes(col.name);
              return (
                <div key={col.name} style={{
                  padding: '4px 8px',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '5px',
                  background: isHighlightedCol ? colors.light : (i % 2 === 0 ? '#fafafa' : '#ffffff'),
                  borderLeft: isHighlightedCol ? `3px solid ${colors.header}` : '3px solid transparent'
                }}>
                  <span style={{ width: '14px', display: 'flex', justifyContent: 'center', flexShrink: 0 }}>
                    {col.isPK && <span style={{ fontSize: '10px' }}>üîë</span>}
                    {col.isFK && !col.isPK && <span style={{ color: '#8b5cf6', fontSize: '11px', fontWeight: 'bold' }}>‚Ä∫</span>}
                    {col.isUnique && !col.isPK && <span style={{ color: '#10b981', fontSize: '8px' }}>‚óâ</span>}
                  </span>
                  <span style={{ flex: 1, fontWeight: col.isPK ? '600' : '400', color: '#1e293b', fontFamily: 'monospace', fontSize: '10px' }}>
                    {col.name}
                  </span>
                  <span style={{ color: '#94a3b8', fontFamily: 'monospace', fontSize: '9px', flexShrink: 0 }}>{col.type}</span>
                </div>
              );
            })}
          </div>
        </div>
      );
    };

    const App = () => {
      const [positions, setPositions] = useState(initialPositions);
      const [hoveredTable, setHoveredTable] = useState(null);
      const [scale, setScale] = useState(0.6);
      const [showTenantLinks, setShowTenantLinks] = useState(true);
      const [showDomainLinks, setShowDomainLinks] = useState(true);

      const handleDrag = useCallback((name, newPos) => {
        setPositions(prev => ({ ...prev, [name]: newPos }));
      }, []);

      const getTableHeight = (tableName) => HEADER_HEIGHT + tables[tableName].columns.length * ROW_HEIGHT;

      const getColY = useCallback((tableName, colName) => {
        const pos = positions[tableName];
        const colIndex = tables[tableName].columns.findIndex(c => c.name === colName);
        return pos.y + HEADER_HEIGHT + colIndex * ROW_HEIGHT + ROW_HEIGHT / 2;
      }, [positions]);

      const getConnection = useCallback((rel, index) => {
        const fromPos = positions[rel.from];
        const toPos = positions[rel.to];
        const fromY = getColY(rel.from, rel.fromCol);
        const toY = getColY(rel.to, rel.toCol);
        
        const fromLeft = fromPos.x;
        const fromRight = fromPos.x + TABLE_WIDTH;
        const toLeft = toPos.x;
        const toRight = toPos.x + TABLE_WIDTH;
        
        let startX, startY, endX, endY;
        let pathPoints = [];
        let arrowDirection;
        
        const offset = (index % 6) * 8;
        
        if (toLeft > fromRight + 20) {
          startX = fromRight;
          startY = fromY;
          endX = toLeft;
          endY = toY;
          arrowDirection = 'right';
          const midX = startX + (endX - startX) / 2 + offset;
          if (Math.abs(startY - endY) < 3) {
            pathPoints = [[startX, startY], [endX, endY]];
          } else {
            pathPoints = [[startX, startY], [midX, startY], [midX, endY], [endX, endY]];
          }
        } else if (fromLeft > toRight + 20) {
          startX = fromLeft;
          startY = fromY;
          endX = toRight;
          endY = toY;
          arrowDirection = 'left';
          const midX = endX + (startX - endX) / 2 - offset;
          if (Math.abs(startY - endY) < 3) {
            pathPoints = [[startX, startY], [endX, endY]];
          } else {
            pathPoints = [[startX, startY], [midX, startY], [midX, endY], [endX, endY]];
          }
        } else {
          const fromCenterX = fromPos.x + TABLE_WIDTH / 2;
          const goRight = fromCenterX < 1000;
          
          if (goRight) {
            const routeX = Math.max(fromRight, toRight) + 30 + offset;
            startX = fromRight;
            startY = fromY;
            endX = toRight;
            endY = toY;
            arrowDirection = 'left';
            pathPoints = [[startX, startY], [routeX, startY], [routeX, endY], [endX, endY]];
          } else {
            const routeX = Math.min(fromLeft, toLeft) - 30 - offset;
            startX = fromLeft;
            startY = fromY;
            endX = toLeft;
            endY = toY;
            arrowDirection = 'right';
            pathPoints = [[startX, startY], [routeX, startY], [routeX, endY], [endX, endY]];
          }
        }
        
        let pathD = `M ${pathPoints[0][0]} ${pathPoints[0][1]}`;
        for (let i = 1; i < pathPoints.length; i++) {
          pathD += ` L ${pathPoints[i][0]} ${pathPoints[i][1]}`;
        }
        
        const arrowSize = 8;
        let arrowPoints;
        if (arrowDirection === 'right') {
          arrowPoints = `${endX},${endY} ${endX - arrowSize},${endY - arrowSize/1.5} ${endX - arrowSize},${endY + arrowSize/1.5}`;
        } else {
          arrowPoints = `${endX},${endY} ${endX + arrowSize},${endY - arrowSize/1.5} ${endX + arrowSize},${endY + arrowSize/1.5}`;
        }
        
        return { pathD, startX, startY, endX, endY, arrowPoints };
      }, [positions, getColY]);

      const activeRels = hoveredTable 
        ? relationships.filter(r => r.from === hoveredTable || r.to === hoveredTable)
        : [];

      const getHighlightedCols = (tableName) => {
        if (!hoveredTable) return [];
        return activeRels
          .filter(r => r.from === tableName || r.to === tableName)
          .map(r => r.from === tableName ? r.fromCol : r.toCol);
      };

      const filteredRelationships = relationships.filter(r => {
        if (r.type === 'tenant' && !showTenantLinks) return false;
        if (r.type === 'domain' && !showDomainLinks) return false;
        return true;
      });

      // Count total columns
      const totalColumns = Object.values(tables).reduce((sum, t) => sum + t.columns.length, 0);

      return (
        <div style={{ width: '100vw', height: '100vh', overflow: 'hidden', background: '#f8fafc' }}>
          {/* Header */}
          <div style={{ 
            background: 'white', padding: '8px 16px', borderBottom: '1px solid #e2e8f0',
            display: 'flex', alignItems: 'center', justifyContent: 'space-between',
            position: 'fixed', top: 0, left: 0, right: 0, zIndex: 1000
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
              <h1 style={{ fontSize: '15px', fontWeight: '600', color: '#1e293b' }}>üìä Database Schema ERD</h1>
              <span style={{ fontSize: '10px', color: '#64748b', background: '#f1f5f9', padding: '3px 8px', borderRadius: '4px' }}>
                {Object.keys(tables).length} tables ‚Ä¢ {totalColumns} columns ‚Ä¢ {filteredRelationships.length} relationships
              </span>
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '10px' }}>
                <label style={{ display: 'flex', alignItems: 'center', gap: '4px', cursor: 'pointer', color: '#64748b' }}>
                  <input type="checkbox" checked={showTenantLinks} onChange={(e) => setShowTenantLinks(e.target.checked)} />
                  <span style={{ display: 'inline-block', width: '12px', height: '3px', background: '#f97316' }}></span>
                  Tenant
                </label>
                <label style={{ display: 'flex', alignItems: 'center', gap: '4px', cursor: 'pointer', color: '#64748b' }}>
                  <input type="checkbox" checked={showDomainLinks} onChange={(e) => setShowDomainLinks(e.target.checked)} />
                  <span style={{ display: 'inline-block', width: '12px', height: '3px', background: '#3b82f6' }}></span>
                  Domain
                </label>
              </div>
              <div style={{ height: '20px', width: '1px', background: '#e2e8f0' }} />
              <button onClick={() => setPositions(initialPositions)} style={{ padding: '5px 10px', border: '1px solid #e2e8f0', borderRadius: '5px', background: 'white', cursor: 'pointer', fontSize: '10px', color: '#64748b' }}>
                Reset
              </button>
              <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                <button onClick={() => setScale(s => Math.max(0.2, s - 0.1))} style={{ width: '26px', height: '26px', border: '1px solid #e2e8f0', borderRadius: '5px', background: 'white', cursor: 'pointer' }}>‚àí</button>
                <span style={{ fontSize: '10px', color: '#64748b', minWidth: '36px', textAlign: 'center' }}>{Math.round(scale * 100)}%</span>
                <button onClick={() => setScale(s => Math.min(1.5, s + 0.1))} style={{ width: '26px', height: '26px', border: '1px solid #e2e8f0', borderRadius: '5px', background: 'white', cursor: 'pointer' }}>+</button>
              </div>
            </div>
          </div>

          {/* Canvas */}
          <div style={{ marginTop: '44px', width: '100%', height: 'calc(100vh - 44px)', overflow: 'auto' }}>
            <div style={{ transform: `scale(${scale})`, transformOrigin: 'top left', position: 'relative', width: '2400px', height: '1500px', background: '#f8fafc' }}>
              
              {/* SVG Connections */}
              <svg style={{ position: 'absolute', top: 0, left: 0, width: '100%', height: '100%', pointerEvents: 'none', zIndex: 0 }}>
                {filteredRelationships.map((rel, index) => {
                  const isActive = hoveredTable ? activeRels.includes(rel) : false;
                  const isVisible = !hoveredTable || isActive;
                  const conn = getConnection(rel, index);
                  const isTenant = rel.type === 'tenant';
                  const color = isTenant ? (isActive ? '#f97316' : '#fdba74') : (isActive ? '#3b82f6' : '#93c5fd');
                  const strokeWidth = isActive ? 2.5 : 1.5;
                  
                  return (
                    <g key={`${rel.from}-${rel.fromCol}-${rel.to}`} style={{ opacity: isVisible ? 1 : 0.1 }}>
                      <path d={conn.pathD} fill="none" stroke={color} strokeWidth={strokeWidth} strokeDasharray={isTenant && !isActive ? '5,3' : 'none'} />
                      <circle cx={conn.startX} cy={conn.startY} r={isActive ? 5 : 4} fill={color} />
                      <polygon points={conn.arrowPoints} fill={color} />
                    </g>
                  );
                })}
              </svg>

              {/* Table Cards */}
              {Object.entries(tables).map(([name, data]) => (
                <TableCard
                  key={name}
                  name={name}
                  data={data}
                  position={positions[name]}
                  onDrag={handleDrag}
                  isHighlighted={hoveredTable === name || activeRels.some(r => r.from === name || r.to === name)}
                  highlightedCols={getHighlightedCols(name)}
                  onMouseEnter={() => setHoveredTable(name)}
                  onMouseLeave={() => setHoveredTable(null)}
                />
              ))}
            </div>
          </div>

          {/* Legend */}
          <div style={{ position: 'fixed', bottom: '10px', right: '10px', background: 'white', borderRadius: '8px', padding: '10px', boxShadow: '0 2px 8px rgba(0,0,0,0.1)', fontSize: '9px', zIndex: 999 }}>
            <div style={{ fontWeight: '600', marginBottom: '4px', color: '#475569' }}>Legend</div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '6px', marginBottom: '3px' }}>
              <svg width="50" height="14">
                <circle cx="6" cy="7" r="4" fill="#f97316"/>
                <line x1="10" y1="7" x2="38" y2="7" stroke="#f97316" strokeWidth="2" strokeDasharray="5,3"/>
                <polygon points="44,7 38,4 38,10" fill="#f97316"/>
              </svg>
              <span style={{ color: '#64748b' }}>Tenant (org/site)</span>
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
              <svg width="50" height="14">
                <circle cx="6" cy="7" r="4" fill="#3b82f6"/>
                <line x1="10" y1="7" x2="38" y2="7" stroke="#3b82f6" strokeWidth="2"/>
                <polygon points="44,7 38,4 38,10" fill="#3b82f6"/>
              </svg>
              <span style={{ color: '#64748b' }}>Domain FK</span>
            </div>
            <div style={{ marginTop: '6px', paddingTop: '6px', borderTop: '1px solid #e5e7eb', color: '#94a3b8' }}>
              ‚óè FK ‚Üí ‚ñ∂ PK
            </div>
          </div>

          {/* Instructions */}
          <div style={{ position: 'fixed', bottom: '10px', left: '50%', transform: 'translateX(-50%)', background: 'white', padding: '6px 14px', borderRadius: '6px', boxShadow: '0 2px 8px rgba(0,0,0,0.1)', fontSize: '10px', color: '#64748b', zIndex: 999 }}>
            üí° Drag tables to rearrange ‚Ä¢ Hover to highlight connections
          </div>
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
